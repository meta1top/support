# GitLab CI/CD 配置文件
# 用于自动发布 npm 包

# 定义全局变量
variables:
  NPM_REGISTRY: "registry.npmjs.org"

# 定义缓存策略
cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store

# 定义阶段
stages:
  - publish

# ===================================
# Nest 库发布任务
# ===================================

# 发布 nest-common 包
publish:nest-common:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^nest-common@/
  before_script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install
  script:
    - pnpm build:types
    - pnpm build:common
    - npm config set //${NPM_REGISTRY}:_authToken ${NPM_TOKEN}
    - cd libs/common/
    - npm publish
  tags:
    - easykit

# 发布 nest-message 包
publish:nest-message:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^nest-message@/
  before_script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install
  script:
    - pnpm build:types
    - pnpm build:common
    - pnpm build:message
    - npm config set //${NPM_REGISTRY}:_authToken ${NPM_TOKEN}
    - cd libs/message/
    - npm publish
  tags:
    - easykit

# 发布 nest-nacos 包
publish:nest-nacos:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^nest-nacos@/
  before_script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install
  script:
    - pnpm build:types
    - pnpm build:common
    - pnpm build:nacos
    - npm config set //${NPM_REGISTRY}:_authToken ${NPM_TOKEN}
    - cd libs/nacos/
    - npm publish
  tags:
    - easykit

# 发布 nest-types 包
publish:nest-types:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^nest-types@/
  before_script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install
  script:
    - pnpm build:types
    - npm config set //${NPM_REGISTRY}:_authToken ${NPM_TOKEN}
    - echo "=== NPM Config List ==="
    - npm config list
    - echo "=== .npmrc Content ==="
    - cat ~/.npmrc
    - cd libs/types/
    - npm publish
  tags:
    - easykit

# ===================================
# 前端包发布任务
# ===================================

# 发布 design 包
publish:design:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^design@/
  script:
    - npm config set //${NPM_REGISTRY}:_authToken ${NPM_TOKEN}
    - cd packages/design/
    - npm publish
  tags:
    - easykit

# 发布 editor 包
publish:editor:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^editor@/
  script:
    - npm config set //${NPM_REGISTRY}:_authToken ${NPM_TOKEN}
    - cd packages/editor/
    - npm publish
  tags:
    - easykit
