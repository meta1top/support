# GitLab CI/CD 配置文件
# 用于自动发布 npm 包

# 定义全局变量
variables:
  NPM_REGISTRY: "registry.npmjs.org"

# 定义缓存策略
cache:
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store
  policy: pull-push

# 定义阶段
stages:
  - publish

# ===================================
# Nest 库发布任务
# ===================================

# 发布 nest-types 包
publish:nest-types:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^nest-types@/
  before_script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install
  script:
    - pnpm build:types
    - echo "registry=https://${NPM_REGISTRY}/" > ~/.npmrc
    - echo "//${NPM_REGISTRY}/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
    - echo "=== NPM Config List ==="
    - npm config list
    - echo "=== .npmrc Content ==="
    - cat ~/.npmrc
    - cd libs/types/
    - npm publish --access public
  tags:
    - easykit
    
# 发布 nest-common 包
publish:nest-common:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^nest-common@/
  before_script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install
  script:
    - pnpm build:types
    - pnpm build:common
    - echo "registry=https://${NPM_REGISTRY}/" > ~/.npmrc
    - echo "//${NPM_REGISTRY}/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
    - cd libs/common/
    - npm publish --access public
  tags:
    - easykit

# 发布 nest-nacos 包
publish:nest-nacos:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^nest-nacos@/
  before_script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install
  script:
    - pnpm build:types
    - pnpm build:common
    - pnpm build:nacos
    - echo "registry=https://${NPM_REGISTRY}/" > ~/.npmrc
    - echo "//${NPM_REGISTRY}/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
    - cd libs/nacos/
    - npm publish --access public
  tags:
    - easykit

# 发布 nest-security 包
publish:nest-security:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^nest-security@/
  before_script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install
  script:
    - pnpm build:types
    - pnpm build:common
    - pnpm build:nacos
    - pnpm build:security
    - echo "registry=https://${NPM_REGISTRY}/" > ~/.npmrc
    - echo "//${NPM_REGISTRY}/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
    - cd libs/security/
    - npm publish --access public
  tags:
    - easykit

# 发布 nest-message 包
publish:nest-message:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^nest-message@/
  before_script:
    - pnpm config set store-dir .pnpm-store
    - pnpm install
  script:
    - pnpm build:types
    - pnpm build:common
    - pnpm build:nacos
    - pnpm build:security
    - pnpm build:message
    - echo "registry=https://${NPM_REGISTRY}/" > ~/.npmrc
    - echo "//${NPM_REGISTRY}/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
    - cd libs/message/
    - npm publish --access public
  tags:
    - easykit

# ===================================
# 前端包发布任务
# ===================================

# 发布 design 包
publish:design:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^design@/
  script:
    - echo "registry=https://${NPM_REGISTRY}/" > ~/.npmrc
    - echo "//${NPM_REGISTRY}/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
    - cd packages/design/
    - npm publish
  tags:
    - easykit

# 发布 editor 包
publish:editor:
  stage: publish
  rules:
    - if: $CI_COMMIT_TAG =~ /^editor@/
  script:
    - echo "registry=https://${NPM_REGISTRY}/" > ~/.npmrc
    - echo "//${NPM_REGISTRY}/:_authToken=${NPM_TOKEN}" >> ~/.npmrc
    - cd packages/editor/
    - npm publish
  tags:
    - easykit
